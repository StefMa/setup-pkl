amends "package://pkg.pkl-lang.org/github.com/stefma/pkl-gha/com.github.action@0.0.3#/GitHubAction.pkl"

// In TypeScript actions, `dist/` is a special directory. When you reference
// an action with the `uses:` property, `dist/index.js` is the code that will be
// run. For this project, the `dist/index.js` file is transpiled from other
// source files. This workflow ensures the `dist/` directory contains the
// expected transpiled code.
//
// If this workflow is run from a feature branch, it will act as an additional CI
// check and fail if the checked-in `dist/` directory does not match what is
// expected from the build.
name = "Check Transpiled JavaScript"

on {
  pull_request {}
  push {
    branches {
      "main"
    }
  }
}

permissions {
  contents = "read"
}

jobs {
  ["check-dist"] {
    name = "Check Dist"
    `runs-on` = "ubuntu-latest"
    steps {
      new {
        name = "Checkout"
        uses = "actions/checkout@v4"
      }
      new {
        name = "Setup Node.js"
        uses = "actions/setup-node@v4"
        with {
          ["node-version-file"] = ".nvmrc"
          ["cache"] = "npm"
        }
      }
      new {
        name = "Install Dependencies"
        run = "npm ci"
      }
      new {
        name = "Build dist/ Directory"
        run = "npm run bundle"
      }
      // This will fail the workflow if the PR wasn't created by Dependabot.
      new {
        name = "Compare Directories"
        run = """
          if [ "$(git diff --ignore-space-at-eol --text dist/ | wc -l)" -gt "0" ]; then
            echo "Detected uncommitted changes after build. See status below:"
            git diff --ignore-space-at-eol --text dist/
            exit 1
          fi
          """
      }
      new {
        name = "Upload Artifact"
        `if` = "${{ failure() && steps.diff.outcome == 'failure' }}"
        uses = "actions/upload-artifact@v4"
        with {
          ["name"] = "dist"
          ["path"] = "dist"
        }
      }
    }
  }
}